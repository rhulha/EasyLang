

Fenster fenster = neu Fenster();

publik nichts start()
{
	fenster.setzeTitel("Sokoban");
	fenster.setzeBreite(800);
	fenster.setzeHöhe(600);
	
	Zeichen[] farben = neu Zeichen[];
	Zeichen[] level = neu Zeichen[];
	Zeichen[] ziele = neu Zeichen[];
	Zahl feldGröße = 40;
	Zahl spielerX = 0;
	Zahl spielerY = 0;
	
	farben["Wand"] = "0x000000";
	farben["Ziel"] = "0x00ff00";
	farben["Spieler"] = "0xff0000";
	farben["Kiste"] = "0x0000ff";
	
	DateiLeser dl = neu DateiLeser("level02.sokoban");
	dl.fürJedeZeile{
		Zeichen zeile -> 
		Zeichen[] parts = zeile.spalte(":");
		level[parts[0]] = parts[1];
		parts[1].istGleich("Spieler"){
			Zeichen[] coords = parts[0].spalte("-");
			spielerX = coords[0].alsZahl();
			spielerY = coords[1].alsZahl();
		}
		parts[1].istGleich("Ziel"){
			ziele[parts[0]] = parts[1]; 
		}
		
	}
	dl.ende();
	
	spielerX.schreibe();
	spielerY.schreibe();

	fenster.setzeTastenDruckBehandler{
	  Zahl taste ->
	  Zahl dx = 0;
	  Zahl dy = 0;
	  
	  # links
	  taste.gleicht(37){
	  	dx = -1;
	  }
	  # hoch
	  taste.gleicht(38){
	  	dy = -1;
	  }
	  # rechts
	  taste.gleicht(39){
	  	dx = 1;
	  }
	  # runter
	  taste.gleicht(40){
	  	dy = 1;
	  }
	  
	  Zeichen zielZeichen = spielerX.plus(dx).und("-").und(spielerY.plus(dy));
	  level.enthältSchlüssel(zielZeichen){
		  Zeichen feld = level[zielZeichen];
		  feld.gleicht("Kiste"){
		  	Zeichen doppelZielZeichen = spielerX.plus(dx).plus(dx).und("-").und(spielerY.plus(dy).plus(dy));
		  	level.enthältSchlüsselNicht(doppelZielZeichen){
		  		level.entferne(zielZeichen);
		  		level[doppelZielZeichen] = "Kiste";
		  	}
		  	level[doppelZielZeichen].gleicht("Ziel"){
		  		level.entferne(zielZeichen);
		  		level[doppelZielZeichen] = "Kiste";
		  	}
		  }
	  }
	  
	  level.enthältSchlüsselNicht(zielZeichen).oder(level[zielZeichen].gleicht("Ziel")){
		  level.entferne(spielerX.und("-").und(spielerY));
		  level[zielZeichen] = "Spieler";
		  spielerX.plus!(dx);
		  spielerY.plus!(dy);
		  fenster.male();
	  }
	  
	  Zahl zähler = 0;
	  ziele.fürJedenSchlüssel{
	  	Zeichen schlüssel ->
	  	level[schlüssel].gleicht("Kiste"){
	  	  zähler.plus!(1);
	  	}
	  }
	  zähler.gleicht(ziele.anzahlSchlüssel()) {
	  	"Sieg".schreibe();
		level.löschen(); 
		ziele.löschen(); 
		DateiLeser dl = neu DateiLeser("level01.sokoban");
		dl.fürJedeZeile{
			Zeichen zeile ->
			Zeichen[] parts = zeile.spalte(":");
			level[parts[0]] = parts[1];
			parts[1].istGleich("Spieler"){
				Zeichen[] coords = parts[0].spalte("-");
				spielerX = coords[0].alsZahl();
				spielerY = coords[1].alsZahl();
			}
			parts[1].istGleich("Ziel"){
				ziele[parts[0]] = parts[1]; 
			}
			
		}
		dl.ende();
	  }
	  
	  
	}
	
	fenster.male{
	  Grafik g ->
		Zahl w = fenster.holeBreite().geteiltDurch( feldGröße);
		Zahl h = fenster.holeHöhe().geteiltDurch( feldGröße);
		w.mal{
			Zahl x ->
			h.mal{
				Zahl y ->
				ziele.enthältSchlüssel(x.und("-").und(y)){
					g.setzeFarbe(farben[ziele[x.und("-").und(y)]]);
					g.fülleRechteck( x.mal(feldGröße), y.mal(feldGröße), feldGröße, feldGröße);  
				}
				level.enthältSchlüssel(x.und("-").und(y)){
					g.setzeFarbe(farben[level[x.und("-").und(y)]]);
					g.fülleRechteck( x.mal(feldGröße), y.mal(feldGröße), feldGröße, feldGröße);  
				}
				g.setzeFarbe("0x000000");
				g.maleRechteck( x.mal(feldGröße), y.mal(feldGröße), feldGröße, feldGröße);
			}
		}
	}

	fenster.zeigeAn();
	
	
}

